# Shiro

[Shiroçš„ä»‹ç»](https://www.infoq.com/articles/apache-shiro/)



## ä»‹ç»

### ä»€ä¹ˆæ˜¯shiro

Apache shiroæ˜¯ä¸€ä¸ªä½¿ç”¨ç®€å•çš„Java å®‰å…¨æ¡†æ¶

shiro æä¾›å››ä¸ªä¿éšœåº”ç”¨å®‰å…¨çš„APIï¼š

- Authentication - proving user identity, often called user â€˜loginâ€™.    è®¤è¯
- Authorization - access control     è®¿é—®æ§åˆ¶
- Cryptography - protecting or hiding data from prying eyes      ğŸ”  
- Session Management - per-user time-sensitive state    Sessionç®¡ç†

### shiroæ ¸å¿ƒæ¦‚å¿µ   Subject, SecurityManager, and Realms

**Subject**

å½“ä½ åœ¨ç»´æŠ¤åº”ç”¨å®‰å…¨æ—¶ï¼Œä½ å¯èƒ½æœ€å…³å¿ƒçš„é—®é¢˜æ˜¯ï¼šâ€œè°æ˜¯å½“å‰ç”¨æˆ·ï¼Ÿâ€æˆ–è€…â€œå½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒåˆ©åšæŸäº‹ï¼Ÿâ€

Subjectæ˜¯ä¸€ä¸ªå®‰å…¨æœ¯è¯­ï¼ŒæŒ‡â€œå½“å‰æ‰§è¡Œç”¨æˆ·â€ï¼Œä¸ä½¿ç”¨userä¸€è¯æ˜¯å› ä¸ºé€šå¸¸è¯¥è¯æŒ‡ä»£äººï¼Œè€Œåœ¨å®‰å…¨æ–¹é¢çš„è¯­å¢ƒä¸­ï¼ŒSubjectå¯ä»¥ä»£è¡¨çš„å«ä¹‰æ›´å¤šï¼Œæ„å‘³ç€æ˜¯å½“å‰ä»»ä½•ä¸è½¯ä»¶äº¤äº’çš„ä¸œè¥¿ã€‚

ä½ å¯ä»¥åœ¨ä»»ä½•ä½ çš„ä»£ç ä¸­éœ€è¦çš„åœ°æ–¹è·å¾—Shiro Subject  

`SecurityUtils.getSubject()`

```java
import org.apache.shiro.subject.Subject;
import org.apache.shiro.SecurityUtils;
...
Subject currentUser = SecurityUtils.getSubject();
```

ä¸€æ—¦è·å¾—äº†Subjectï¼Œå°±å¯ä»¥åˆ©ç”¨shiroå¯¹å½“å‰ç”¨æˆ·åšè®¸å¤šäº‹æƒ…ï¼Œæ¯”å¦‚loginã€logoutã€è®¿é—®ç”¨æˆ·sessionã€æ‰§è¡Œæˆæƒç¡®è®¤ç­‰ç­‰ã€‚

[Subjectçš„åˆ›å»º](https://blog.51cto.com/dengshuangfu/2361227)

SubjectUtilsç›´æ¥ä»ThreadContextä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰å†åˆ›å»ºå†ç»‘å®šåˆ°ThreadContextä¸Šï¼Œè€ŒThreadContexté‡Œé¢ç»´æŒç€ä¸€ä¸ªLocalThreadå¯¹è±¡ï¼Œå¯è§**Subjectæ˜¯ä¸å½“å‰çº¿ç¨‹ç›¸ç»‘å®šçš„**



SubjectUtilsï¼š

```java
 public static Subject getSubject() {
        Subject subject = ThreadContext.getSubject();
        if (subject == null) {
            subject = (new Subject.Builder()).buildSubject();
            ThreadContext.bind(subject);
        }
        return subject;
    }
```



å¯ä»¥çœ‹åˆ°Subjectåˆ°åˆ›å»ºæ˜¯Builderå§”æ‰˜ç»™SecurityManageræ¥åˆ›å»ºçš„

Subjectï¼šå†…éƒ¨ç±»Builder

```java
 public Builder() {
            this(SecurityUtils.getSecurityManager());
        }

        /**
         * Constructs a new {@link Subject.Builder} instance which will use the specified {@code SecurityManager} when
         * building the {@code Subject} instance.
         *
         * @param securityManager the {@code SecurityManager} to use when building the {@code Subject} instance.
         */
        public Builder(SecurityManager securityManager) {
            if (securityManager == null) {
                throw new NullPointerException("SecurityManager method argument cannot be null.");
            }
            this.securityManager = securityManager;
            this.subjectContext = newSubjectContextInstance();
            if (this.subjectContext == null) {
                throw new IllegalStateException("Subject instance returned from 'newSubjectContextInstance' " +
                        "cannot be null.");
            }
            this.subjectContext.setSecurityManager(securityManager);
        }

public Subject buildSubject() {
            return this.securityManager.createSubject(this.subjectContext);
        }
}
```











**SecurityManager**

> The Subjectâ€™s â€˜behind the scenesâ€™ counterpart is the SecurityManager

Subjectçš„å¹•åæ˜¯SecurityManager ï¼ŒSubjectä»£è¡¨å½“å‰ç”¨æˆ·çš„å®‰å…¨æ“ä½œ(security operations)ï¼ŒSecurityManageråˆ™ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„å®‰å…¨æ“ä½œã€‚å®ƒåœ¨shiroç»“æ„ä¸­æ˜¯æ ¸å¿ƒã€‚

ä½†æ˜¯ä¸€æ—¦é…ç½®å¥½äº†ä¹‹åå°±ä¸éœ€è¦ç†ä¼šï¼Œå¼€å‘è€…å¯ä»¥èŠ±è´¹æ›´å¤šæ—¶é—´åœ¨Subjectçš„API

SecurityManageréœ€è¦æ˜¯å•ä¾‹çš„





**Realms**

ä¸€ä¸ªrealmä½œä¸ºShiroå’Œä½ çš„åº”ç”¨å®‰å…¨æ•°æ®çš„â€œæ¡¥æ¢â€ã€‚å½“æ¶‰åŠåˆ°ç¡®åˆ‡åœ°ä¸å®‰å…¨ç›¸å…³çš„æ•°æ®äº¤äº’æ—¶ï¼Œä¾‹å¦‚å¯¹ç”¨æˆ·è´¦æˆ·è¿›è¡Œè®¤è¯å’Œæˆæƒæ—¶ï¼ŒShiroä¼šå¯»æ‰¾è®¸å¤šä¸ä¹‹ç›¸å…³çš„reamlé…ç½®ã€‚

realmæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹å®šçš„DAOï¼šå®ƒéœ€è¦è·å¾—ç›¸å…³çš„æ•°æ®ç»™Shiroï¼Œå½“ä½ é…ç½®Shiroï¼Œä½ å¿…é¡»æ˜ç¡®è‡³å°‘ä¸€ä¸ªrealmç”¨äºè®¤è¯å’Œ/æˆ–è€…æˆæƒã€‚



## Authentication

Authenticationæ˜¯æ ¸å¯¹ç”¨æˆ·èº«ä»½çš„è¿‡ç¨‹ã€‚é€šå¸¸éœ€è¦ä¸‰æ­¥ï¼š

1. æ”¶é›†  1âƒ£ï¸ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œå³principalsã€2âƒ£ï¸èº«ä»½çš„è¾…åŠ©è¯æ˜ï¼šcredentialsï¼ˆèµ„æ ¼ï¼‰

2. æäº¤principalså’Œcredentialsç»™system
3. å¦‚æœæäº¤çš„credentialsç¬¦åˆsystemæ‰€æœŸå¾…çš„ï¼Œåˆ™é€šè¿‡è®¤è¯ã€‚

Shiroçš„AuthenticationTokenæ¥å£

```java
public interface AuthenticationToken extends Serializable {
    Object getPrincipal();
    Object getCredentials();
}
```



é€šå¸¸åœ¨ç”¨æˆ·ç™»å½•åˆ°æŸä¸ªè½¯ä»¶åº”ç”¨æ—¶ï¼Œä¼šæä¾›ç”¨æˆ·å(principal)å’Œå¯†ç (credential)ï¼ŒShiroæ”¯æŒè¿™æ ·ç›¸åŒçš„å·¥ä½œæµç¨‹ã€‚

ä½ å¯ä»¥è°ƒç”¨loginæ–¹æ³•ï¼Œé€šè¿‡Authentication Tokenå®ä¾‹ã€‚

**Subject Login**

```java
//1. Acquire submitted principals and credentials:
AuthenticationToken token = new UsernamePasswordToken(username, password);
//2. Get the current Subject:
Subject currentUser = SecurityUtils.getSubject();

//3. Login:
currentUser.login(token);
```

å½“è°ƒç”¨loginæ–¹æ³•æ—¶ï¼ŒSecurityManagerä¼šæ¥æ”¶AuthenticationTokenå¹¶ä¸”å‘é€åˆ°é…ç½®å¥½çš„ä¸€ä¸ªæˆ–å¤šä¸ªrealmï¼ˆå¯è‡ªå®šä¹‰ï¼‰ä¸­è¿›è¡Œè®¤è¯ã€‚

**Handle Failed Login**

å½“ç”¨æˆ·éªŒè¯å¤±è´¥æ—¶ï¼Œå¯ä»¥åšä¸€äº›runtimeå¼‚å¸¸å¤„ç†

```java
//3. Login:
try {
    currentUser.login(token);
} catch (IncorrectCredentialsException ice) { â€¦
} catch (LockedAccountException lae) { â€¦
}
â€¦
catch (AuthenticationException ae) {â€¦
} 
```



## Authorization

å½“ä¸€ä¸ªSubjectçš„loginæˆåŠŸåï¼Œä»£è¡¨è®¤è¯æˆåŠŸï¼Œé€šå¸¸è¢«è®¤ä¸ºå…è®¸ä½¿ç”¨ä½ çš„åº”ç”¨ï¼Œä½†æ˜¯ä¸æ„å‘³ç€å®ƒä»¬å¯ä»¥éšæ„ä½¿ç”¨ä½ çš„åº”ç”¨ï¼Œä½ è¿˜éœ€è¦æ§åˆ¶ç”¨æˆ·çš„è®¿é—®æƒé™â€”â€”Authorizationã€‚

ä¸€ä¸ªç”¨æˆ·çš„è®¿é—®æ§åˆ¶é€šå¸¸åˆ©ç”¨â€œrolesâ€å’Œâ€œpermissionsâ€çš„æ¦‚å¿µã€‚

**RoleCheck**

åŸºäºè§’è‰²

```java
subject.hasRole("administrator")
```

**PermissionCheck**

å¦ä¸€ç§æ–¹å¼å®ç°æˆæƒï¼ŒåŸºäºrolesçš„ä¾‹å­å±•ç°äº†ä¸€ä¸ªæ˜æ˜¾çš„ç‘•ç–µï¼Œä½ æ— æ³•åœ¨è¿è¡Œæ—¶æ·»åŠ å’Œåˆ é™¤roleï¼Œä»£ç ä¸­å†™æ­»äº†roleçš„åå­—ã€‚ä¸ºæ­¤Shiroè¿˜æä¾›äº†åŸºäºpermissionçš„æˆæƒã€‚ä½ å¯ä»¥åœ¨è¿è¡Œæ—¶ç»™roleåˆ†é…permissionã€‚



### ç†è§£Apache Shiroçš„Permissions

Permissionï¼šåœ¨Shiroä¸­è¡¨ç¤ºå®šä¹‰äº†å…·ä½“è¡Œä¸ºæˆ–è€…åŠ¨ä½œçš„å£°æ˜ã€‚



#### Wildcard Permissions Usage

æˆäºˆç”¨æˆ·è®¸å¯

```ini
printer:query
```

è¿™é‡Œçš„`:`ç•Œå®šäº†åŠ¨ä½œä½œç”¨åŸŸ(domain)å’ŒåŠ¨ä½œ(action)ã€‚ 

ä¹Ÿå¯ä»¥è¿™æ ·ï¼š

```ini
printer:print,query  #ä»£è¡¨ç»™ç”¨æˆ·åˆ†é…ä¸¤ä¸ªpermission
printer:manage
```

é€šé…

`*`

```ini
printer:* 
====== ç­‰æ•ˆäº====
printer:query,print,manage
```

ä¹Ÿå¯ä»¥ç”¨äºå†’å·å‰é¢

```ini
*:view
```





æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸpermission

```java
subject.isPermitted("printer:query");
```

#### Instance-Level è®¿é—®æ§åˆ¶

å†’å·åˆ†å‰²çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼šdomain:action(s):instance(s)

exampleï¼š

```ini
printer:query:lp7200
printer:print:epsoncolor
```

ä½¿ç”¨é€šé…ï¼š

```ini
printer:print:*      # ä»£è¡¨å¯ä»¥
printer:*:*
printer:*:lp7200
printer:query,print:lp7200
```

çœç•¥ç›¸å½“äº`*`

```ini
printer:print     
<===> 
printer:print:*
```

```ini
printer
<===>
printer:*:*
```

ä½†æ˜¯æ³¨æ„ï¼š

```ini
printer:lp7200  
```

is **not** equivalent to

```ini
printer:*:lp7200
```

